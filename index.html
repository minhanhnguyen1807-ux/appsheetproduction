
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In L·ªánh S·∫£n Xu·∫•t</title>
    
    <!-- Th∆∞ vi·ªán QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Th∆∞ vi·ªán xu·∫•t PDF (html2pdf) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- C·∫§U H√åNH C∆† B·∫¢N --- */
        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        body {
            font-family: "Times New Roman", Times, serif;
            background-color: #525659; /* M√†u n·ªÅn t·ªëi gi·ªëng tr√¨nh xem PDF */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- KHUNG GI·∫§Y A4 --- */
        #print-area {
            background-color: white;
            width: 210mm; /* Chi·ªÅu r·ªông chu·∫©n A4 */
            min-height: 297mm; /* Chi·ªÅu cao chu·∫©n A4 */
            padding: 15mm 15mm; /* CƒÉn l·ªÅ an to√†n ƒë·ªÉ kh√¥ng b·ªã m√°y in c·∫Øt */
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            overflow: hidden; /* NgƒÉn n·ªôi dung tr√†n ra ngo√†i */
        }

        /* --- THANH C√îNG C·ª§ (N√öT B·∫§M) --- */
        .toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover { transform: translateY(-2px); }
        .btn-print { background-color: #28a745; } /* M√†u xanh l√° */
        .btn-pdf { background-color: #dc3545; }   /* M√†u ƒë·ªè */

        /* --- WATERMARK --- */
        .watermark {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 90px;
            color: rgba(255, 0, 0, 0.1);
            border: 8px solid rgba(255, 0, 0, 0.1);
            padding: 20px 40px;
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
            display: none;
            white-space: nowrap;
        }

        /* --- B·ªê C·ª§C N·ªòI DUNG --- */
        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .company-info h1 { font-size: 18px; margin: 0 0 5px 0; text-transform: uppercase; }
        .company-info p { margin: 2px 0; font-size: 12px; }

        .title-section { text-align: center; margin-bottom: 20px; }
        .title-section h2 { font-size: 24px; margin: 0; text-transform: uppercase; }
        .lsx-number { font-size: 14px; font-weight: bold; margin-top: 5px; }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 20px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .info-row { display: flex; border-bottom: 1px dotted #ccc; padding-bottom: 2px;}
        .info-label { font-weight: bold; width: 120px; flex-shrink: 0;}
        .info-value { flex: 1; word-wrap: break-word; }

        /* --- B·∫¢NG BI·ªÇU --- */
        .section-header {
            font-size: 13px; font-weight: bold; text-transform: uppercase;
            margin-bottom: 5px; margin-top: 15px;
            border-left: 4px solid #333; padding-left: 6px; background-color: #f1f1f1;
        }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; }
        th, td { border: 1px solid #000; padding: 4px; }
        th { background-color: #e0e0e0; text-align: center; font-weight: bold; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }

        /* --- FOOTER K√ù T√äN --- */
        .footer-sign {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            text-align: center;
            page-break-inside: avoid; /* Tr√°nh b·ªã c·∫Øt ƒë√¥i khi in */
        }
        .sign-box { width: 30%; font-size: 12px; }
        .sign-title { font-weight: bold; text-transform: uppercase; margin-bottom: 50px; }

        /* --- C·∫§U H√åNH MEDIA PRINT (KHI B·∫§M CTRL+P) --- */
        @page { size: A4 portrait; margin: 0; }
        @media print {
            body { background: white; padding: 0; }
            .toolbar { display: none !important; } /* ·∫®n n√∫t khi in */
            #print-area {
                box-shadow: none; margin: 0; width: 100%; height: auto;
                page-break-after: always;
            }
        }
    </style>
</head>
<body>

    <!-- THANH C√îNG C·ª§ -->
    <div class="toolbar">
        <button class="btn btn-print" onclick="window.print()">
            üñ®Ô∏è In Ngay
        </button>
        <button class="btn btn-pdf" onclick="downloadPDF()">
            üì• T·∫£i PDF
        </button>
    </div>

    <!-- KHUNG GI·∫§Y A4 -->
    <div id="print-area">
        <!-- Watermark -->
        <div id="watermark" class="watermark">B·∫¢N IN DEMO</div>

        <!-- Header -->
        <div class="header">
            <div class="company-info">
                <h1>C√îNG TY S·∫¢N XU·∫§T BAO B√å ABC</h1>
                <p>ƒêC: KCN VSIP, B√¨nh D∆∞∆°ng | MST: 3700123456</p>
                <p>Tel: 0274.123.456 | Email: contact@abc.com</p>
            </div>
            <div id="qrcode"></div>
        </div>

        <!-- Ti√™u ƒë·ªÅ -->
        <div class="title-section">
            <h2>L·ªÜNH S·∫¢N XU·∫§T</h2>
            <div class="lsx-number" id="txt_lenh_sx">...</div>
        </div>

        <!-- Th√¥ng tin chung -->
        <div class="info-grid">
            <div class="info-row"><span class="info-label">Kh√°ch h√†ng:</span><span class="info-value" id="txt_khach_hang">...</span></div>
            <div class="info-row"><span class="info-label">M√£ S·∫£n Ph·∫©m:</span><span class="info-value" id="txt_ma_sp">...</span></div>
            <div class="info-row"><span class="info-label">Ng√†y b·∫Øt ƒë·∫ßu:</span><span class="info-value" id="txt_ngay_bd">...</span></div>
            <div class="info-row"><span class="info-label">S·ªë l∆∞·ª£ng ƒë·∫∑t:</span><span class="info-value" id="txt_sl_dat">...</span></div>
            <div class="info-row"><span class="info-label">H·∫°n giao h√†ng:</span><span class="info-value" id="txt_han_giao">...</span></div>
            <div class="info-row"><span class="info-label">Ng√†y in phi·∫øu:</span><span class="info-value" id="txt_ngay_in">...</span></div>
        </div>

        <!-- I. V·∫≠t T∆∞ -->
        <div class="section-header">I. ƒê·ªäNH M·ª®C V·∫¨T T∆Ø (BOM)</div>
        <table>
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="30%">M√£/T√™n V·∫≠t T∆∞</th>
                    <th width="10%">ƒêVT</th>
                    <th width="15%">ƒê·ªãnh M·ª©c</th>
                    <th width="15%">SL Y√™u C·∫ßu</th>
                    <th width="10%">Hao h·ª•t</th>
                    <th width="15%">Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody id="tbody_khvt"></tbody>
        </table>

        <!-- II. S·∫£n Xu·∫•t -->
        <div class="section-header">II. QUY TR√åNH S·∫¢N XU·∫§T</div>
        <table>
            <thead>
                <tr>
                    <th width="5%">STT</th>
                    <th width="25%">C√¥ng ƒêo·∫°n</th>
                    <th width="15%">M√°y SX</th>
                    <th width="15%">B·∫Øt ƒê·∫ßu</th>
                    <th width="15%">K·∫øt Th√∫c</th>
                    <th width="10%">SL KH</th>
                    <th width="15%">Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody id="tbody_khsx"></tbody>
        </table>

        <!-- Footer -->
        <div class="footer-sign">
            <div class="sign-box">
                <div class="sign-title">NG∆Ø·ªúI L·∫¨P L·ªÜNH</div>
                <div>(K√Ω, h·ªç t√™n)</div>
            </div>
            <div class="sign-box">
                <div class="sign-title">QU·∫¢N ƒê·ªêC X∆Ø·ªûNG</div>
                <div>(K√Ω, h·ªç t√™n)</div>
            </div>
            <div class="sign-box">
                <div class="sign-title">DUY·ªÜT S·∫¢N XU·∫§T</div>
                <div>(K√Ω, h·ªç t√™n)</div>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // 1. DATA DEMO
        const demoData = {
            lenh_sx: "LSX-20251209-001 (DEMO)",
            khach_hang: "KH001 - CTY TNHH TH·ª∞C PH·∫®M VI·ªÜT",
            ma_san_pham: "SP-HOP-BANH-20x20",
            sl_dat_hang: "5,000 c√°i",
            ngay_bat_dau: "09/12/2025",
            han_giao_hang: "15/12/2025",
            qr_code: "DEMO-QR",
            khvt: [
                { ma_vat_tu: "GIAY-KRAFT-300", dvt: "kg", sl_dinh_muc: "0.25", sl_yeu_cau: "1,250", sl_bu_hao: "10", ghi_chu: "Gi·∫•y cu·ªôn kh·ªï 1.2m" },
                { ma_vat_tu: "MUC-IN-OFFSET", dvt: "kg", sl_dinh_muc: "0.01", sl_yeu_cau: "50", sl_bu_hao: "2", ghi_chu: "H·ªá 4 m√†u CMYK" },
                { ma_vat_tu: "KEO-DAN-NUOC", dvt: "l√≠t", sl_dinh_muc: "0.005", sl_yeu_cau: "25", sl_bu_hao: "1", ghi_chu: "" }
            ],
            khsx: [
                { ten_cong_doan: "C·∫Øt gi·∫•y cu·ªôn", may_san_xuat: "M√ÅY C·∫ÆT 01", ngay_bat_dau: "09/12/2025 08:00", thoi_han_hoan_thanh: "09/12/2025 17:00", sl_yeu_cau: "5000", ghi_chu: "" },
                { ten_cong_doan: "In Offset", may_san_xuat: "M√ÅY IN 4 M√ÄU", ngay_bat_dau: "10/12/2025 08:00", thoi_han_hoan_thanh: "11/12/2025 17:00", sl_yeu_cau: "5000", ghi_chu: "Ki·ªÉm tra m√†u k·ªπ" },
                { ten_cong_doan: "B·∫ø h·ªôp", may_san_xuat: "M√ÅY B·∫æ T·ª∞ ƒê·ªòNG", ngay_bat_dau: "12/12/2025 08:00", thoi_han_hoan_thanh: "13/12/2025 12:00", sl_yeu_cau: "5000", ghi_chu: "" }
            ]
        };

        // 2. L·∫§Y PARAMS URL
        function getParams() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has("lenh_sx")) return null;
            
            const safeParse = (str) => {
                try { return JSON.parse(str || "[]"); } catch (e) { return []; }
            };

            return {
                lenh_sx: params.get("lenh_sx"),
                khach_hang: params.get("khach_hang"),
                ma_san_pham: params.get("ma_san_pham"),
                sl_dat_hang: params.get("sl_dat_hang"),
                ngay_bat_dau: params.get("ngay_bat_dau"),
                han_giao_hang: params.get("han_giao_hang"),
                qr_code: params.get("qr_code"),
                khvt: safeParse(params.get("khvt_json")),
                khsx: safeParse(params.get("khsx_json"))
            };
        }

        // 3. RENDER D·ªÆ LI·ªÜU
        function render() {
            let data = getParams();
            if (!data) {
                data = demoData;
                document.getElementById("watermark").style.display = "block";
            }

            // Th√¥ng tin chung
            document.getElementById("txt_lenh_sx").textContent = data.lenh_sx;
            document.getElementById("txt_khach_hang").textContent = data.khach_hang;
            document.getElementById("txt_ma_sp").textContent = data.ma_san_pham;
            document.getElementById("txt_sl_dat").textContent = data.sl_dat_hang;
            document.getElementById("txt_ngay_bd").textContent = data.ngay_bat_dau;
            document.getElementById("txt_han_giao").textContent = data.han_giao_hang;
            
            const now = new Date();
            document.getElementById("txt_ngay_in").textContent = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

            // QR Code
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: data.qr_code || data.lenh_sx,
                width: 70, height: 70
            });

            // B·∫£ng KHVT
            const tbodyVT = document.getElementById("tbody_khvt");
            if (data.khvt && data.khvt.length > 0) {
                tbodyVT.innerHTML = data.khvt.map((row, i) => `
                    <tr>
                        <td class="text-center">${i+1}</td>
                        <td>${row.ma_vat_tu || ''}</td>
                        <td class="text-center">${row.dvt || ''}</td>
                        <td class="text-right">${row.sl_dinh_muc || ''}</td>
                        <td class="text-right">${row.sl_yeu_cau || ''}</td>
                        <td class="text-right">${row.sl_bu_hao || ''}</td>
                        <td>${row.ghi_chu || ''}</td>
                    </tr>
                `).join('');
            } else tbodyVT.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';

            // B·∫£ng KHSX
            const tbodySX = document.getElementById("tbody_khsx");
            if (data.khsx && data.khsx.length > 0) {
                tbodySX.innerHTML = data.khsx.map((row, i) => `
                    <tr>
                        <td class="text-center">${i+1}</td>
                        <td>${row.ten_cong_doan || ''}</td>
                        <td class="text-center">${row.may_san_xuat || ''}</td>
                        <td class="text-center">${(row.ngay_bat_dau || '').replace(/:00$/, '')}</td>
                        <td class="text-center">${(row.thoi_han_hoan_thanh || '').replace(/:00$/, '')}</td>
                        <td class="text-right">${row.sl_yeu_cau || ''}</td>
                        <td>${row.ghi_chu || ''}</td>
                    </tr>
                `).join('');
            } else tbodySX.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }

        // 4. CH·ª®C NƒÇNG T·∫¢I PDF
        function downloadPDF() {
            const element = document.getElementById('print-area');
            const lsxCode = document.getElementById('txt_lenh_sx').textContent;
            
            // C·∫•u h√¨nh cho html2pdf
            const opt = {
                margin:       0, // ƒê√£ cƒÉn l·ªÅ trong CSS c·ªßa #print-area
                filename:     `LSX_${lsxCode}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true }, // Scale 2 ƒë·ªÉ n√©t h∆°n
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Th·ª±c thi
            html2pdf().set(opt).from(element).save();
        }

        window.onload = render;
    </script>
</body>
</html>
